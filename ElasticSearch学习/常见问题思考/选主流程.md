# 选主流程

## 一、问题

在学习节点时，看到知识点说 每个节点在启动的时候都会选择自己作为 Master 节点。**那每个节点都选择自己作为主节点，最终主节点是怎么选举出来的呢**？

## 二、为什么每个节点都尝试成为 Master？

在分布式系统中，每个节点并不知道其他节点的状态，因此在节点启动时，都会尝试成为主节点（这是一个保守的设计）。ElasticSearch 中，**只有配置了 `node.master: true` 的节点才会参与竞选**。

## 三、真正的主节点是如何选出来的？

ElasticSearch 使用一种称为 **Zen Discovery** 的机制（在较新版本中演化为 **Zen2**）来进行主节点选举。其核心流程如下：

1. **节点发现（Discovery）**：
   - 每个节点在启动时会向集群中其他节点发送 ping 请求，尝试发现已有的节点。
2. **组成选举候选集**：
   - 节点会把自己和它发现的其他符合条件的节点作为候选。
3. **达到法定票数（Quorum）**：
   - 要成功选出主节点，**必须有 `minimum_master_nodes`（旧版本）或者自动确定的仲裁数量（在 Zen2 中）在线**。这个机制防止脑裂。
4. **对比节点 ID（或 UUID）进行选举**：
   - 在候选集中，节点会比较每个节点的 ID，通常选择 ID 最大的作为 Master（实际是基于一个稳定的排序规则）。
5. **其余节点接受这个主节点**：
   - 一旦主节点被选出，其余节点就会加入它，形成完整的集群。

## 四、举个例子

假设有 3 个节点 A、B、C，都是 `node.master: true`：

- 刚启动时，A、B、C 都认为自己可以成为主节点。
- 经过 ping 和 discovery，彼此发现了对方。
- 比如 ID 最大的是 C，那最终选举 C 为 Master。
- A 和 B 会向 C 发起加入请求，成为 Data Node 或 Master-eligible Node。