# 脑裂

## 一、什么是脑裂？

**脑裂**指的是在一个分布式系统中，**由于网络分区或节点异常，集群被“分成了多个部分”，每一部分都以为自己才是“主集群”或“主节点”**。

就像一个大脑被一刀切成了两半，两边都以为自己才是大脑核心，彼此不知对方还在运作——于是系统状态就会“分裂”，产生严重的**数据不一致、冲突**甚至**数据丢失**。

## 二、举个例子（ElasticSearch 场景）

假设你有 5 个 ElasticSearch 节点：A、B、C、D、E。

- A 是当前主节点。
- 然后由于网络问题，集群被“断开”成两部分：

```wiki
分区1：A, B
分区2：C, D, E
```

现在的问题是：

- A 失去了 C、D、E 的连接，只能看到 B，于是它觉得自己还可以继续当主节点。
- 同时，C、D、E 也看不到 A，于是它们重新选举一个新的主节点（比如 C）。
- 于是你就有 **两个主节点**，分别是 A 和 C。

这就是“脑裂”！两个“脑子”在同时控制数据，很容易写入不一致的数据。

## 三、脑裂的后果

- **数据不一致**：两个主节点各自接受写入，数据不统一。
- **数据丢失**：合并集群时，冲突数据可能被覆盖。
- **集群崩溃**：当脑裂被检测到后，ElasticSearch 会强制关闭集群或拒绝服务，来避免进一步损坏数据。

## 四、ElasticSearch 如何防止脑裂？

#### 旧版（Zen Discovery）：

你需要手动设置一个参数：discovery.zen.minimum_master_nodes: (N/2) + 1

例如你有 5 个 master-eligible 节点，必须设置为：minimum_master_nodes: 3

意思是：**少于 3 个节点不能选主节点**，这样分区1（A,B）就不会误以为可以当主了。

#### 新版（Zen2，ElasticSearch 7.x+）：

使用自动的 **投票机制 + 持久状态日志（cluster coordination）**，自动判断是否达到法定票数，不需要设置 `minimum_master_nodes`，**防脑裂的能力更强、更智能。**

## 五、总结一句话

**脑裂 = 分布式集群分区后，多个部分各自认为自己是“主”而导致混乱。**

ElasticSearch 通过**投票机制、法定票数（quorum）机制**防止脑裂。